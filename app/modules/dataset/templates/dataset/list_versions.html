{% extends "base_template.html" %}

{% block title %}Version History{% endblock %}

{% block content %}

<div class="row mb-3">
    <div class="col-12">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Explore</a></li>
                
                {% if dataset.ds_meta_data.dataset_doi %}
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('dataset.subdomain_index', doi=dataset.ds_meta_data.dataset_doi) }}">
                            {{ dataset.ds_meta_data.title }}
                        </a>
                    </li>
                {% else %}
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('dataset.get_unsynchronized_dataset', dataset_id=dataset.id) }}">
                            {{ dataset.ds_meta_data.title }}
                        </a>
                    </li>
                {% endif %}
                
                <li class="breadcrumb-item active">Versions</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2>
                    <i data-feather="clock"></i>
                    Version History
                </h2>
                
                <!-- BotÃ³n crear versiÃ³n (solo propietario y NO sincronizado) -->
                {% if current_user.is_authenticated and current_user.id == dataset.user_id and not dataset.ds_meta_data.dataset_doi %}
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createVersionModal">
                    <i data-feather="plus"></i> Create New Version
                </button>
                {% endif %}
            </div>
            
            <div class="card-body">
                
                <!-- âœ… Obtener la Ãºltima versiÃ³n (mÃ¡s reciente) -->
                {% set latest_version = versions[0] if versions else None %}
                
                {% for version in versions %}
                <div class="card mb-3 {% if loop.first %}border-primary{% endif %}">
                    <div class="card-header {% if loop.first %}bg-primary text-white{% endif %}">
                        <div class="row align-items-center">
                            <!-- Columna izquierda: InformaciÃ³n de la versiÃ³n -->
                            <div class="col-md-8 col-12 mb-2 mb-md-0">
                                <h4 class="mb-1">
                                    <!-- Badge de versiÃ³n -->
                                    <span class="badge {% if version.id == latest_version.id %}bg-success{% else %}bg-secondary{% endif %}">
                                        v{{ version.version_number }}
                                    </span>
                                    {{ version.title }}
                                    
                                    <!-- Badge "Current" solo en la Ãºltima -->
                                    {% if version.id == latest_version.id %}
                                    <span class="badge bg-success">Current</span>
                                    {% endif %}
                                </h4>
                                <p class="mb-0 {% if loop.first %}text-white-50{% else %}text-muted{% endif %}">
                                    <small>
                                        <i data-feather="user" style="width: 14px; height: 14px;"></i>
                                        {{ version.created_by.profile.name }}
                                        â€¢
                                        <i data-feather="calendar" style="width: 14px; height: 14px;"></i>
                                        {{ version.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                    </small>
                                </p>
                            </div>
                            
                            <!-- Columna derecha: Botones de acciÃ³n -->
                            <div class="col-md-4 col-12 text-md-end">
                                {% if not loop.last %}
                                    <!-- âœ… BotÃ³n comparar con versiÃ³n anterior (AMARILLO en current, AZUL en anteriores) -->
                                    {% set previous_version = versions[loop.index] %}
                                    <a href="{{ url_for('dataset.compare_versions', version1_id=version.id, version2_id=previous_version.id) }}" 
                                       class="btn btn-sm {% if loop.first %}btn-warning text-dark{% else %}btn-primary text-white{% endif %} fw-bold shadow-sm"
                                       title="Compare v{{ version.version_number }} with v{{ previous_version.version_number }}">
                                        <i data-feather="git-compare" style="width: 16px; height: 16px;"></i>
                                        <span class="d-none d-lg-inline">Compare with previous</span>
                                        <span class="d-inline d-lg-none">Compare</span>
                                    </a>
                                {% else %}
                                    <!-- Badge para la primera versiÃ³n -->
                                    <span class="badge bg-secondary fs-6 py-2 px-3">
                                        <i data-feather="award" style="width: 14px; height: 14px;"></i>
                                        First version
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <!-- Changelog -->
                        <div class="mb-3">
                            <h6><strong>Changes:</strong></h6>
                            <pre class="bg-light p-2 rounded">{{ version.changelog }}</pre>
                        </div>
                        
                        <!-- âœ… EstadÃ­sticas especÃ­ficas por tipo -->
                        {% if dataset.dataset_kind == 'gpx' %}
                        <div class="row">
                            <div class="col-12">
                                <h6><i data-feather="activity"></i> <strong>GPX Statistics:</strong></h6>
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-md-3 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>km</strong></h6>
                                        <p class="mb-0"><small>Distance</small></p>
                                        <h5 class="mb-0">{{ "%.1f"|format(version.total_distance / 1000) if version.total_distance else '-' }}</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>{{ "%.1f"|format(version.total_elevation_gain) if version.total_elevation_gain else '-' }} m</strong></h6>
                                        <p class="mb-0"><small>Elevation Gain</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>{{ version.track_count or '-' }}</strong></h6>
                                        <p class="mb-0"><small>Tracks</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>{{ version.total_points or '-' }}</strong></h6>
                                        <p class="mb-0"><small>Points</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {% elif dataset.dataset_kind == 'uvl' %}
                        <div class="row">
                            <div class="col-12">
                                <h6><strong>UVL Statistics:</strong></h6>
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-md-4 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>{{ version.model_count or '-' }}</strong></h6>
                                        <p class="mb-0"><small>Models</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>{{ version.total_features or '-' }}</strong></h6>
                                        <p class="mb-0"><small>Features</small></p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 col-6 mb-2">
                                <div class="card bg-light">
                                    <div class="card-body py-2">
                                        <h6 class="mb-0"><strong>{{ version.total_constraints or '-' }}</strong></h6>
                                        <p class="mb-0"><small>Constraints</small></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Files -->
                        <div class="mt-3">
                            <h6><i data-feather="file"></i> <strong>Files ({{ version.files_snapshot|length }}):</strong></h6>
                            <ul class="list-group list-group-flush">
                                {% for filename, info in version.files_snapshot.items() %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        <i data-feather="file"></i>
                                        {{ filename }}
                                    </span>
                                    <span class="text-muted">
                                        <small>{{ (info.size / 1024)|round(2) }} KB</small>
                                    </span>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                {% if not versions %}
                <div class="alert alert-info">
                    <i data-feather="info"></i>
                    No versions found for this dataset.
                </div>
                {% endif %}
                
            </div>
        </div>
    </div>
</div>

<!-- Modal crear versiÃ³n -->
{% if current_user.is_authenticated and current_user.id == dataset.user_id and not dataset.ds_meta_data.dataset_doi %}
<div class="modal fade" id="createVersionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('dataset.create_version', dataset_id=dataset.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i data-feather="git-branch"></i> Create New Version
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <small>A snapshot of the current state will be saved.</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Version Type</label>
                        <select class="form-select" name="bump_type" id="bump_type">
                            <option value="patch" selected>ðŸ”§ Patch (X.Y.Z+1) - Bug fixes</option>
                            <option value="minor">âœ¨ Minor (X.Y+1.0) - New features</option>
                            <option value="major">ðŸš€ Major (X+1.0.0) - Breaking changes</option>
                        </select>
                        <small class="text-muted" id="versionPreview">
                            Current version: <strong>v{{ latest_version.version_number if latest_version else '0.0.0' }}</strong>
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="changelog" class="form-label">Changelog <span class="text-danger">*</span></label>
                        <textarea 
                            class="form-control" 
                            id="changelog" 
                            name="changelog" 
                            rows="4" 
                            required
                            placeholder="Describe the changes made in this version...&#10;Example:&#10;- Fixed bug in GPX parsing&#10;- Added new elevation metrics&#10;- Updated documentation"
                        ></textarea>
                        <small class="text-muted">Describe what changed in this version</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i data-feather="x"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="save"></i> Create Version
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- âœ… Estilos CSS para mejorar visibilidad -->
<style>
    /* BotÃ³n comparar - versiÃ³n actual (amarillo brillante) */
    .bg-primary .btn-warning {
        background-color: #ffc107;
        border-color: #ffc107;
        color: #000;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .bg-primary .btn-warning:hover {
        background-color: #ffb300;
        border-color: #ffb300;
        color: #000;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    /* BotÃ³n comparar - versiones anteriores (azul) */
    .btn-primary {
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(13,110,253,0.3);
    }
    
    /* Badge "First version" mÃ¡s grande */
    .badge.fs-6 {
        font-size: 0.95rem !important;
    }
    
    /* Asegurar que los botones sean visibles */
    .card-header .btn {
        white-space: nowrap;
        min-width: auto;
    }
    
    /* Responsive: ajustar en mÃ³vil */
    @media (max-width: 992px) {
        .btn-sm {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }
        
        .card-header .row {
            gap: 0.5rem;
        }
    }
    
    /* Mejorar contraste del card con fondo azul */
    .bg-primary {
        background-color: #0d6efd !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Inicializar iconos Feather
        feather.replace();
        
        // Preview de la nueva versiÃ³n al cambiar tipo
        const bumpTypeSelect = document.getElementById('bump_type');
        if (bumpTypeSelect) {
            bumpTypeSelect.addEventListener('change', function() {
                const currentVersion = '{{ latest_version.version_number if latest_version else "0.0.0" }}';
                const [major, minor, patch] = currentVersion.split('.').map(Number);
                
                let newVersion;
                switch(this.value) {
                    case 'major':
                        newVersion = `${major + 1}.0.0`;
                        break;
                    case 'minor':
                        newVersion = `${major}.${minor + 1}.0`;
                        break;
                    case 'patch':
                    default:
                        newVersion = `${major}.${minor}.${patch + 1}`;
                        break;
                }
                
                // Actualizar el preview
                const preview = document.getElementById('versionPreview');
                preview.innerHTML = `Current version: <strong>v${currentVersion}</strong> â†’ New version will be: <strong class="text-success">v${newVersion}</strong>`;
            });
        }
    });
</script>

{% endblock %}